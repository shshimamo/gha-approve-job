name: Execute

on:
  workflow_call:
    inputs:
      command:
        description: 'Command to execute'
        required: true
        type: string

jobs:
  execute:
    runs-on: ubuntu-latest
    environment: job-production-execute
    steps:
      - name: Verify caller workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Verifying workflow run ${{ github.run_id }}..."

          # workflow_call は呼び出し元と同じ run_id を共有するため、
          # gh run view で承認ワークフローの情報を取得できる
          RUN_INFO=$(gh run view ${{ github.run_id }} --repo ${{ github.repository }} --json workflowName,jobs)

          WORKFLOW_NAME=$(echo "$RUN_INFO" | jq -r '.workflowName')
          echo "Workflow name: $WORKFLOW_NAME"

          EXPECTED_NAME="Approve and Execute"
          if [ "$WORKFLOW_NAME" != "$EXPECTED_NAME" ]; then
            echo "::error::Workflow name mismatch. Expected '$EXPECTED_NAME', got '$WORKFLOW_NAME'"
            exit 1
          fi
          echo "Workflow name verified"

          # approve ジョブの conclusion を確認
          # ※ workflow_call は同一 run 内で実行されるため、run 全体の conclusion はまだ success にならない
          #   代わりに approve ジョブ単体の conclusion をチェックする
          APPROVE_CONCLUSION=$(echo "$RUN_INFO" | jq -r '.jobs[] | select(.name == "approve") | .conclusion')
          echo "Approve job conclusion: $APPROVE_CONCLUSION"

          if [ "$APPROVE_CONCLUSION" != "success" ]; then
            echo "::error::Approve job has not succeeded. Conclusion: $APPROVE_CONCLUSION"
            exit 1
          fi
          echo "Approve job verification passed"

      - name: Execute command
        run: |
          echo "=== Executing command ==="
          echo "${{ inputs.command }}"
          echo "=== Command completed ==="
